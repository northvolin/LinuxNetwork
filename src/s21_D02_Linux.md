## Part 1. Инструмент **ipcalc**

#### 1.1. Сети и маски

Определяем:

1. Адрес сети 192.167.38.54/13


![](/src/screenshots/Part1.1.PNG)


2. Перевод маски 255.255.255.0 в префиксную и двоичную запись:


![](/src/screenshots/Part1.1.2.1.PNG)


- /15 в обычную и двоичную:


![](/src/screenshots/Part1.1.2.2.PNG)

- 11111111.11111111.11111111.11110000 в обычную и префиксную:


![](/src/screenshots/Part1.1.2.3.PNG)


3. Минимальный и максимальный хост в сети 12.167.38.4 при масках:
- /8:


![](/src/screenshots/Part1.1.3.1.PNG)


- 11111111.11111111.00000000.00000000:


![](/src/screenshots/Part1.1.3.2.PNG)


- 255.255.254.0:


![](/src/screenshots/Part1.1.3.3.PNG)


- /4:


![](/src/screenshots/Part1.1.3.4.PNG)


#### 1.2. localhost

Определяем можно ли обратиться к приложению, работающему на localhost, со следующими IP с помощью команды ping: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1

-IP с которыми можно:

127.0.0.2, 127.1.0.1

-Нельзя:

194.34.23.100, 128.0.0.1, при пинговании этих адрессов получаем 100% потерю пакетов.

#### 1.3. Диапазоны и сегменты сетей

1. Какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: 10.0.0.45, 134.43.0.2, 192.168.4.2, 172.20.250.4, 172.0.2.1, 192.172.0.1, 172.68.0.2, 172.16.255.255, 10.10.10.10, 192.169.168.1

К частным "серым" адресам относятся IP-адреса из следующих подсетей: От 10.0.0.0 до 10.255.255.255 с маской 255.0.0.0 или /8. От 172.16.0.0 до 172.31.255.255 с маской 255.240.0.0 или /12. От 192.168.0.0 до 192.168.255.255 с маской 255.255.0.0 или /16.

-Частные:

10.0.0.45, 10.10.10.10, 172.20.250.4, 172.16.255.255, 192.168.4.2

-Публичные:

134.43.0.2, 192.168.4.2, 172.68.0.2, 192.169.168.1, 172.0.2.1

2. Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18: 10.0.0.1, 10.10.0.2, 10.10.10.10, 10.10.100.1, 10.10.1.255:

-Возможны:

10.10.0.2, 10.10.10.10, 10.10.1.255

-Невозможны:

10.0.0.1, 10.10.100.1

## Part 2. Статическая маршрутизация между двумя машинами

1. С помощью команды `ip a` смотрим существующие сетевые интерфейсы:


![](/src/screenshots/Part2.0.1.PNG)


2. Описываем сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задаем следующие адреса и маски:

-ws1 - 192.168.100.10, маска /16 и ws2 - 172.24.116.8, маска /12:


![](/src/screenshots/Part2.0.2.PNG)


3. Выполняем команду `netplan apply` для перезапуска сервиса сети:


![](/src/screenshots/Part2.0.3.PNG)


#### 2.1. Добавление статического маршрута вручную.

1. Добавляем статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`:


![](/src/screenshots/Part2.1.1.PNG)


2. Пингуем соединение между машинами:


![](/src/screenshots/Part2.1.2.PNG)


#### 2.2. Добавление статического маршрута с сохранением

Перезапускаем машины с помощью команды `reboot`.

1. Добавляем статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml:


![](/src/screenshots/Part2.2.1.PNG)


После, применяем изменения с помощью команды `sudo netplan apply`.

2. Пропинговать соединение между машинами:


![](/src/screenshots/Part2.2.2.PNG)


## Part 3. Утилита **iperf3**

#### 3.1. Скорость соединения

1. Переводим значения скоростей:

- 8 Mbps = 1 MB/s,

- 100 MB/s = 800000 Kbps,

- 1 Gbps = 1000 Mbps,

#### 3.2. Утилита **iperf3**

1. Измерение скорости соединения между ws1 и ws2:

- Для начала устанавливаем утилиту iperf3 c помощью команды `sudo apt install iperf3`.

- Устанавливаем ws1 как сервер:


![](/src/screenshots/Part3.2.1.PNG)


- Измеряем скорость соединения:

![](/src/screenshots/Part3.2.2.PNG)


## Part 4. Сетевой экран

#### 4.1. Утилита **iptables**

1. Создаем файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2 и добавляем в файл подряд следующие правила:

- На ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
- На ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
- Открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
- Запретить *echo reply* (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
- Разрешить *echo reply* (машина должна "пинговаться")


![](/src/screenshots/Part4.1.PNG)


2. Запускаем файлы на обеих машинах командами `chmod +x /etc/firewall.sh` и `/etc/firewall.sh`:

![](/src/screenshots/Part4.1.1.PNG)


`Разница стратегий состоит в том, что правила обрабатываются сверху вниз и применяется то правило, которое выше, а остальные игнорируются.`

#### 4.2. Утилита **nmap**

1. Командой **ping** находим машину, которая не "пингуется", после чего утилитой **nmap** показываем, что хост машины запущен:

*Проверка: в выводе nmap должно быть сказано: `Host is up`*

![](/src/screenshots/Part4.2.PNG)


## Part 5. Статическая маршрутизация сети

Сеть: \

![](/misc/images/part5_network.png)

#### 5.1. Настройка адресов машин

1. Настраиваем конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.

![](/src/screenshots/Part5.1.1.PNG)


2. Перезапускаем сервис сети и командой `ip -4 a` проверяем, что адрес машины задан верно.


![](/src/screenshots/Part5.1.2.PNG)


3. Пингуем ws22 с ws21 и r1 с ws11.


![](/src/screenshots/Part5.1.3.PNG)


#### 5.2. Включение переадресации IP-адресов.

1. Для включения переадресации IP, выполняем команду на роутерах:
   `sysctl -w net.ipv4.ip_forward=1`
   *При таком подходе переадресация не будет работать после перезагрузки системы.*


![](/src/screenshots/Part5.2.1.PNG)


2. Открываем файл */etc/sysctl.conf* и добавляем в него следующую строку:
   `net.ipv4.ip_forward = 1`
   *При использовании этого подхода, IP-переадресация включена на постоянной основе.*


![](/src/screenshots/Part5.2.2.PNG)

#### 5.3. Установка маршрута по-умолчанию

1. Настраиваем маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавляем `default` перед IP роутера в файле конфигураций.


![](/src/screenshots/Part5.3.1.PNG)

2. Вызываем `ip r` и показываем, что добавился маршрут в таблицу маршрутизации.


![](/src/screenshots/Part5.3.2.PNG)


3. Пингуем с ws11 роутер r2 и показываем на r2, что пинг доходит. Для этого используем команду:
   `tcpdump -tn -i eth1`


![](/src/screenshots/Part5.3.3.PNG)


#### 5.4. Добавление статических маршрутов

1. Добавляем в роутеры r1 и r2 статические маршруты в файле конфигураций.


![](/src/screenshots/Part5.4.1.PNG)

2. Вызваем `ip r` и показываем таблицы с маршрутами на обоих роутерах.


![](/src/screenshots/Part5.4.2.PNG)

3. Запускаем следующие команды на ws11:
- `ip r list 10.10.0.0/[18]` и `ip r list 0.0.0.0/0`


![](/src/screenshots/Part5.4.3.PNG)

`Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, хотя он попадает под маршрут по-умолчанию, потому что мы явно задали его в конфигурации роутера.`

#### 5.5. Построение списка маршрутизаторов

1. При помощи утилиты **traceroute** строим список маршрутизаторов на пути от ws11 до ws21 и запускаем на r1 команду дампа `tcpdump -tnv -i eth0`.


![](/src/screenshots/Part5.5.PNG)

`Утилита Traceroute формирует UDP-датаграмму (сообщение, которое нужно доставить целевому серверу), упаковывает ее в IP-пакет и передаёт первому транзитному узлу. В заголовке такого IP-пакета есть поле TTL (Time To Live) — время жизни пакета. Оно определяет количество хопов, через которые пакет может пройти.`

#### 5.6. Использование протокола **ICMP** при маршрутизации

1. Запускаем на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды `tcpdump -n -i eth0 icmp` и пингуем с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
   `ping -c 1 10.30.0.111`.


![](/src/screenshots/Part5.6.PNG)

## Part 6. Динамическая настройка IP с помощью **DHCP**

*В данном задании используются виртуальные машины из Части 5*

Для r2 настраиваем в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**:

1) Указываем адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.


![](/src/screenshots/Part6.1.PNG)

2) В файле *resolv.conf* прописываем `nameserver 8.8.8.8.`


![](/src/screenshots/Part6.2.PNG)

1. Перезагружаем службу **DHCP** командой `systemctl restart isc-dhcp-server`.



2. Машину ws21 перезагружаем при помощи `reboot` и через `ip a` показываем, что она получила адрес.


![](/src/screenshots/Part6.4.PNG)


![](/src/screenshots/Part6.5.PNG)


3. Пингуем ws22 с ws21.


![](/src/screenshots/Part6.6.PNG)


4. Указываем MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* добавляем строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`.


![](/src/screenshots/Part6.7.PNG)


Для r1 настраиваем аналогично r2, но делаем выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Проводим аналогичные тесты.

1) Указываем адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.


![](/src/screenshots/Part6.8.PNG)


2) В файле *resolv.conf* прописываем `nameserver 8.8.8.8.` и перезагружаем службу **DHCP** командой `systemctl restart isc-dhcp-server`.


![](/src/screenshots/Part6.9.PNG)


1. Машину ws11 перезагружаем при помощи `reboot` и через `ip a` показываем, что она получила адрес.


![](/src/screenshots/Part6.10.PNG)


2. Пингуем с ws11 ws21.


![](/src/screenshots/Part6.11.PNG)


Запросить с ws21 обновление ip адреса.

1. До обновления.


![](/src/screenshots/Part6.12.PNG)


2. Обновляем при помощи команд `$ sudo dhclient -r enp0s8` и `$ sudo dhclient enp0s8` и показываем ip после.


![](/src/screenshots/Part6.13.PNG)


Команда `sudo dhclient -r enp0s8` освобождает текущий адрес enp0s8, `sudo dhclient enp0s8` присваивает новый.

## Part 7. **NAT**

*В данном задании используются виртуальные машины из Части 5*

1. В файле */etc/apache2/ports.conf* на ws22 и r1 меняем строку `Listen 80` на `Listen 0.0.0.0:80`, то есть делаем сервер Apache2 общедоступным.


![](/src/screenshots/Part7.1.PNG)


2. Запускаем веб-сервер Apache командой `service apache2 start` на ws22 и r1.


![](/src/screenshots/Part7.2.PNG)


3. Добавляем в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:

- Удаление правил в таблице filter - `iptables -F`

- Удаление правил в таблице "NAT" - `iptables -F -t nat`

- Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`


![](/src/screenshots/Part7.3.PNG)


4. Запускаем файл также, как в Части 4.


![](/src/screenshots/Part7.4.PNG)


5. Проверяем соединение между ws22 и r1 командой `ping`.
   *При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1*.


![](/src/screenshots/Part7.5.PNG)


5. Добавляем в файл ещё одно правило:

- Разрешаем маршрутизацию всех пакетов протокола **ICMP**.


![](/src/screenshots/Part7.6.PNG)


6. Запускаем файл также, как в Части 4.


![](src/screenshots/Part7_firewall.PNG)


7. Проверяем соединение между ws22 и r1 командой `ping`.
   *При запуске файла с этими правилами, ws22 должна "пинговаться" с r1*.


![](/src/screenshots/Part7.7.PNG)


8. Добавляем в файл ещё одно правило:

- Включаем **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0).

- Включаем **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети.


![](/src/screenshots/Part7.8.PNG)


7. Запускаем файл также, как в Части 4.


![](/src/screenshots/Part7_firewall.PNG)


8. Проверяем соединение по TCP для **SNAT**, для этого с ws22 подключаемся к серверу Apache на r1 командой`telnet [адрес] [порт]`.


![](/src/screenshots/Part7.9.PNG)


9. Проверяем соединение по TCP для **DNAT**, для этого с r1 подключаемся к серверу Apache на ws22 командой `telnet` (обращаемся по адресу r2 и порту 8080).


![](/src/screenshots/Part7.10.PNG)


## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

1. Запускаем на r2 фаервол с правилами из Части 7.


![](src/screenshots/Part7_firewall.PNG)


2. Запускаем веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* изменяем строку `Listen 80` на `Listen localhost:80`).


![](/src/screenshots/Part8.2.PNG)


3. Используем *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21.


![](/src/screenshots/Part8.3.PNG)


4. Используем *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11.


![](/src/screenshots/Part8.4.PNG)


5. Для проверки, сработало ли подключение в обоих предыдущих пунктах выполняем команду `telnet 127.0.0.1 80`.


![](/src/screenshots/Part8.5.PNG)


6. Использованные команды:

Для *Local TCP forwarding*:

1. ssh -L "local_port":"destination_host":"destination_port" "username"@"ssh_server"

Где:
- `local_port` - локальный порт, через который будет перенаправляться трафик.
- `destination_host` - удаленный хост или IP-адрес, на который будет перенаправлен трафик.
- `destination_port` - порт на удаленном хосте, к которому будет перенаправлен трафик.
- `username` - ваше имя пользователя на удаленном хосте (SSH сервере).
- `ssh_server` - хост или IP-адрес SSH сервера, с которого вы устанавливаете SSH соединение.

Для *Remote TCP forwarding*:

1. ssh -R "remote_port":"destination_host":"destination_port" "username"@"ssh_server"

Где:
- `remote_port` - удаленный порт, через который будет перенаправляться трафик.
- `destination_host` - удаленный хост или IP-адрес, на который будет перенаправлен трафик с удаленного порта.
- `destination_port` - порт на удаленном хосте, к которому будет перенаправлен трафик.
- `username` - ваше имя пользователя на удаленном хосте (SSH сервере).
- `ssh_server` - хост или IP-адрес SSH сервера, с которого вы устанавливаете SSH соединен.
